<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ã‚»ãƒ„ã®ãƒ–ãƒ©ãƒƒã‚¯ãƒ›ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700&display=swap');

        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #000000;
            color: #fff;
            font-family: 'Avenir', Hiragino Sans, Arial, sans-serif;
            overflow-x: hidden;
            text-align: center;
            padding: 20px 0;
        }

        #game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #game-container {
            position: relative;
            width: 95vmin;
            height: 95vmin;
            max-width: 600px;
            max-height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: black;
        }

        #game-canvas {
            position: relative;
            z-index: 2;
            background-color: transparent;
            width: 100%;
            height: 100%;
        }

        #ui-container {
            position: absolute;
            top: 2%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3;
            color: white;
            font-size: clamp(1rem, 4vmin, 1.8rem);
            text-shadow: 2px 2px 4px #000;
            display: flex;
            justify-content: space-between;
            width: 90%;
            pointer-events: none;
        }

        #instructions {
            position: absolute;
            bottom: 2%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3;
            color: white;
            font-size: clamp(0.8rem, 2.5vmin, 1rem);
            text-shadow: 2px 2px 4px #000;
            pointer-events: none;
        }

        #start-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            cursor: pointer;
        }
        #start-screen h1 {
            font-size: clamp(1.5rem, 6vmin, 2.2rem);
            margin-bottom: 10px;
            padding: 0 10px;
        }
        #start-screen p {
            font-size: clamp(1rem, 3.5vmin, 1.2rem);
        }
        #final-score {
            font-size: clamp(1.2rem, 4.5vmin, 1.5rem);
            margin: 20px 0;
            color: rgb(21, 131, 182);
        }

        #leaderboard {
            width: 95vmin;
            max-width: 600px;
            padding: 15px;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-top: 20px;
        }
        #leaderboard h2 {
            margin-top: 0;
            color: #0000ff;
            font-size: clamp(1.2rem, 4.5vmin, 1.5rem);
        }
        #leaderboard ol {
            padding-left: 25px;
            margin: 0;
            list-style-type: decimal;
        }
        #leaderboard li {
            font-size: clamp(0.9rem, 3vmin, 1rem);
            padding: 4px 0;
            display: flex;
            justify-content: space-between;
        }
        #leaderboard .score-val {
            font-weight: bold;
            color: #ffffff;
            margin-left: 10px;
        }
        #user-id-display {
            position: fixed;
            bottom: 5px;
            left: 5px;
            font-size: 0.7em;
            color: rgba(255,255,255,0.3);
            z-index: 20;
        }

    </style>
</head>
<body>

    <div id="game-wrapper">
        <div id="game-container">
            <canvas id="game-canvas"></canvas>
            <div id="ui-container">
                <span id="score">ã‚¨ãƒ“ãƒ•ãƒ©ã‚¤: 0</span>
                <span id="timer"></span>
            </div>
            <div id="instructions">
                Use â—€ï¸ / â–¶ï¸ keys <br> or <br> tap the screen!
            </div>

            <div id="start-screen">
                <h1>
                    <img src="top.jpg" alt="catch me if you can" style="width: 80%; max-width: 400px; height: auto;">
                    <br>ãƒ­ã‚»ãƒ„ã¨ã‚¨ãƒ“ãƒ•ãƒ©ã‚¤
                </h1>
                <p id="start-text">Click or Tap to Start â–¶ï¸ </p>
                <div id="final-score"></div>
            </div>
        </div>
        <div id="leaderboard">
            <h2>ğŸš€ğŸ¤ HIGH SCORE RANKING ğŸ¤ğŸš€</h2>
            <ol id="score-list"></ol>
        </div>
    </div>
    <div id="user-id-display"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyBDl5BYLTUbMQtuLqvXdlxpw1Ir0wX6NQg",
            authDomain: "rosetsu-game.firebaseapp.com",
            projectId: "rosetsu-game",
            storageBucket: "rosetsu-game.firebasestorage.app",
            messagingSenderId: "679751851017",
            appId: "1:679751851017:web:57ea539491b2ac91162cd8"
        };

        // --- DOMè¦ç´ ã®å–å¾— ---
        const canvas        = document.getElementById('game-canvas');
        const ctx           = canvas.getContext('2d');
        const scoreEl       = document.getElementById('score');
        const timerEl       = document.getElementById('timer');
        const startScreen   = document.getElementById('start-screen');
        const startText     = document.getElementById('start-text');
        const finalScoreEl  = document.getElementById('final-score');
        const gameContainer = document.getElementById('game-container');
        const scoreListEl   = document.getElementById('score-list');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- ã‚²ãƒ¼ãƒ è¨­å®š ---
        let score = 0;
        let gameRunning = false;
        const GAME_DURATION = 30;
        let timerId;
        let timeLeft = GAME_DURATION;

        // --- ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºè¨­å®š ---
        let size = gameContainer.clientWidth;
        canvas.width  = size;
        canvas.height = size;
        let center = { x: size / 2, y: size / 2 };

        // --- Firebase åˆæœŸåŒ– ---
        let db, auth, userId;
        try {
            if (firebaseConfig.apiKey === "YOUR_API_KEY" || !firebaseConfig.apiKey) {
                throw new Error("Firebase config is not set. Please follow the setup guide.");
            }
            const app = initializeApp(firebaseConfig);
            db   = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId.slice(0,8)}...`;
                    setupLeaderboardListener();
                }
            });
            signInAnonymously(auth);

        } catch (error) {
            console.error(error.message);
            scoreListEl.innerHTML = '<li>Firebaseã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚ã‚¬ã‚¤ãƒ‰ã«å¾“ã£ã¦è¨­å®šæƒ…å ±ã‚’ã‚³ãƒ¼ãƒ‰ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</li>';
            userIdDisplay.textContent = "DBè¨­å®šã‚¨ãƒ©ãƒ¼";
            startText.innerHTML = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã‚’ä½¿ã†ã«ã¯<br>è¨­å®šãŒå¿…è¦ã§ã™";
        }

        // --- SVGãƒ‡ãƒ¼ã‚¿å®šç¾© ---
        const rosetsuSVG = `...çœç•¥...`;
        const shrimpSVG  = `...çœç•¥...`;
        const komaruSVG  = `...çœç•¥...`;
        const cucumberSVG = `...çœç•¥...`;
        const carSVG     = `...çœç•¥...`;
        // --- â˜… æ–°è¦è¿½åŠ  ---
        const baseballSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 60"><circle cx="30" cy="30" r="25" fill="white" stroke="black" stroke-width="1.2"/><path d="M12 15 Q30 22,48 15" fill="none" stroke="#e53935" stroke-width="2"/><path d="M12 45 Q30 38,48 45" fill="none" stroke="#e53935" stroke-width="2"/><g stroke="#e53935" stroke-width="1.2"><line x1="17" y1="18" x2="20" y2="19"/><line x1="23" y1="20" x2="26" y2="21"/><line x1="29" y1="22" x2="32" y2="23"/><line x1="35" y1="22" x2="38" y2="23"/><line x1="41" y1="20" x2="44" y2="19"/><line x1="17" y1="42" x2="20" y2="41"/><line x1="23" y1="40" x2="26" y2="39"/><line x1="29" y1="38" x2="32" y2="37"/><line x1="35" y1="38" x2="38" y2="37"/><line x1="41" y1="40" x2="44" y2="41"/></g></svg>`;

        const tetsujiSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 250 140"><g transform="translate(40,10)"><ellipse cx="15" cy="70" rx="18" ry="12" fill="#f5deb3" stroke="black" stroke-width="2" transform="rotate(-40 15 70)"/><ellipse cx="85" cy="75" rx="55" ry="32" fill="#f5deb3" stroke="black" stroke-width="2"/><path d="M110 92 q18 20 -6 23 q-19 -1 -14 -22 z" fill="#f5deb3" stroke="black" stroke-width="2"/><path d="M70 92 q-18 18 5 22 q18 -1 13 -21 z" fill="#f5deb3" stroke="black" stroke-width="2"/><rect x="70" y="57" width="52" height="10" rx="5" fill="black"/><g transform="translate(95,67)"><circle r="8" fill="white" stroke="black" stroke-width="1.2"/><path d="M-5 -4 q5 3 10 0" fill="none" stroke="#e53935" stroke-width="1.3"/><path d="M-5  4 q5 -3 10 0" fill="none" stroke="#e53935" stroke-width="1.3"/></g><ellipse cx="96" cy="47" rx="40" ry="28" fill="#f5deb3" stroke="black" stroke-width="2"/><ellipse cx="96" cy="57" rx="25" ry="9" fill="#3d3532" stroke="black" stroke-width="1.5"/><ellipse cx="60" cy="42" rx="16" ry="14" fill="#f5deb3" stroke="black" stroke-width="2"/><ellipse cx="132" cy="42" rx="16" ry="14" fill="#f5deb3" stroke="black" stroke-width="2"/><g fill="black"><circle cx="82" cy="49" r="5"/><circle cx="110" cy="49" r="5"/><circle cx="80.5" cy="48" r="1.5" fill="white"/><circle cx="108.5" cy="48" r="1.5" fill="white"/><circle cx="96" cy="60" r="4"/><path d="M90 66 q6 4 12 0" fill="none" stroke="white" stroke-width="2"/></g><g stroke="#3d3532" stroke-width="4" stroke-linecap="round" fill="none"><path d="M74 41 q7 -6 14 0"/><path d="M102 41 q7 -6 14 0"/></g></g></svg>`;

        // --- ç”»åƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ ---
        const rosetsuImage  = new Image(); rosetsuImage.src  = `data:image/svg+xml;base64,${btoa(rosetsuSVG)}`;
        const shrimpImage   = new Image(); shrimpImage.src   = `data:image/svg+xml;base64,${btoa(shrimpSVG)}`;
        const komaruImage   = new Image(); komaruImage.src   = `data:image/svg+xml;base64,${btoa(komaruSVG)}`;
        const cucumberImage = new Image(); cucumberImage.src = `data:image/svg+xml;base64,${btoa(cucumberSVG)}`;
        const carImage      = new Image(); carImage.src      = `data:image/svg+xml;base64,${btoa(carSVG)}`;
        const baseballImage = new Image(); baseballImage.src = `data:image/svg+xml;base64,${btoa(baseballSVG)}`;
        const tetsujiImage  = new Image(); tetsujiImage.src  = `data:image/svg+xml;base64,${btoa(tetsujiSVG)}`;

        // --- ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š ---
        let player = {};
        let komaruPlayer  = null;
        let tetsujiPlayer = null;     // â˜… è¿½åŠ 
        let shrimps   = [];
        let cucumbers = [];
        let baseballs = [];           // â˜… è¿½åŠ 
        let cars      = [];

        let shrimpData   = {};
        let cucumberData = {};
        let baseballData = {};        // â˜… è¿½åŠ 
        let carData      = {};

        const keys = { left: false, right: false };
        let lastSpawn     = -1;
        let lastCarSpawn  = -1;
        let baseballHasBeenCaught  = false; // â˜… è¿½åŠ 
        let cucumberHasBeenCaught  = false;
        let feverTimerId = null;
        let isFeverTime  = false;

        // --- åˆæœŸåŒ–/ãƒªã‚»ãƒƒãƒˆ ---
        function resetObjects() {
            player = { size: size * 0.08, angle: 0, speed: 0.05, orbitRadius: size * 0.3, x: 0, y: 0 };
            komaruPlayer  = null;
            tetsujiPlayer = null; // â˜…

            shrimps   = [];
            cucumbers = [];
            baseballs = []; // â˜…
            cars      = [];

            shrimpData   = { size: size * 0.06, spawnRate: 1000, originalSpawnRate: 1000, speed: 1 };
            cucumberData = { size: size * 0.05, speed: 2 };
            baseballData = { size: size * 0.06, speed: 1.8 }; // â˜…
            carData      = { size: size * 0.08, speed: 1.3 };

            cucumberHasBeenCaught = false;
            baseballHasBeenCaught = false; // â˜…

            clearTimeout(feverTimerId);
            isFeverTime = false;
            if(shrimpData.spawnRate !== shrimpData.originalSpawnRate) {
                shrimpData.spawnRate = shrimpData.originalSpawnRate;
            }
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        window.addEventListener('keydown', (e) => {
            if(!gameRunning) return;
            if (e.key === 'ArrowLeft')  keys.left  = true;
            if (e.key === 'ArrowRight') keys.right = true;
        });
        window.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft')  keys.left  = false;
            if (e.key === 'ArrowRight') keys.right = false;
        });
        canvas.addEventListener('touchstart', (e) => {
            if(!gameRunning) return;
            e.preventDefault();
            const touchX = e.touches[0].clientX - canvas.getBoundingClientRect().left;
            keys.left  = touchX < canvas.width / 2;
            keys.right = touchX >= canvas.width / 2;
        });
        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            keys.left = keys.right = false;
        });
        startScreen.addEventListener('click', () => { if (!gameRunning && firebaseConfig.apiKey !== "YOUR_API_KEY") startGame() });

        // --- ã‚²ãƒ¼ãƒ é–‹å§‹/çµ‚äº† ---
        function startGame() {
            gameRunning   = true;
            score         = 0;
            timeLeft      = GAME_DURATION;
            finalScoreEl.textContent = '';
            startText.textContent    = 'Click or Tap to Start â–¶ï¸';
            startScreen.style.display = 'none';
            resetObjects();
            updateScore();
            timerEl.textContent = `æ®‹ã‚Šæ™‚é–“: ${timeLeft}`;
            timerId = setInterval(() => {
                timeLeft--;
                timerEl.textContent = `æ®‹ã‚Šæ™‚é–“: ${timeLeft}`;
                if (timeLeft <= 0) endGame();
            }, 1000);
            gameLoop();
        }

        async function endGame() {
            clearInterval(timerId);
            gameRunning = false;
            keys.left = keys.right = false;
            finalScoreEl.textContent = `Final Score: ${score}`;
            startText.textContent    = "Play Againï¼";
            startScreen.style.display = 'flex';

            if (db && userId) {
                try {
                    await addDoc(collection(db, "scores"), { userId, score, timestamp: serverTimestamp() });
                } catch (error) { console.error("Error writing document: ", error); }
            }
        }

        // --- ãƒ•ã‚£ãƒ¼ãƒãƒ¼ç®¡ç† ---
        function startFeverTime() {
            const FEVER_DURATION   = 3000;
            const FEVER_SPAWN_RATE = 100;
            isFeverTime = true;
            shrimpData.spawnRate = FEVER_SPAWN_RATE;
            clearTimeout(feverTimerId);
            feverTimerId = setTimeout(endFeverTime, FEVER_DURATION);
        }
        function endFeverTime() {
            isFeverTime = false;
            shrimpData.spawnRate = shrimpData.originalSpawnRate;
            komaruPlayer = null;
        }

        // --- ã‚¹ãƒãƒ¼ãƒ³é–¢æ•°ç¾¤ ---
        const spawnShrimp = () => commonSpawn(shrimps);
        const spawnCucumber = () => commonSpawn(cucumbers);
        const spawnBaseball = () => commonSpawn(baseballs); // â˜…
        const spawnCar      = () => commonSpawn(cars);

        function commonSpawn(arr) {
            const angle  = Math.random() * Math.PI * 2;
            const radius = size * 0.48;
            arr.push({ x: center.x + radius * Math.cos(angle), y: center.y + radius * Math.sin(angle), angle });
        }

        // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ›´æ–° ---
        function updatePlayer() {
            if (keys.left)  player.angle -= player.speed;
            if (keys.right) player.angle += player.speed;
            player.x = center.x + player.orbitRadius * Math.cos(player.angle);
            player.y = center.y + player.orbitRadius * Math.sin(player.angle);

            if (komaruPlayer) {
                komaruPlayer.angle = player.angle + Math.PI;
                komaruPlayer.x = center.x + komaruPlayer.orbitRadius * Math.cos(komaruPlayer.angle);
                komaruPlayer.y = center.y + komaruPlayer.orbitRadius * Math.sin(komaruPlayer.angle);
            }
            if (tetsujiPlayer) {
                tetsujiPlayer.angle = player.angle + Math.PI / 2; // 90åº¦ãšã‚‰ã™
                tetsujiPlayer.x = center.x + tetsujiPlayer.orbitRadius * Math.cos(tetsujiPlayer.angle);
                tetsujiPlayer.y = center.y + tetsujiPlayer.orbitRadius * Math.sin(tetsujiPlayer.angle);
            }
        }

        // --- ã‚¢ã‚¤ãƒ†ãƒ æ›´æ–° ---
        function updateItems() {
            updateShrimps();
            updateCucumbers();
            updateBaseballs();
            updateCars();
        }

        function moveTowardsCenter(obj, speed) {
            const dx = center.x - obj.x;
            const dy = center.y - obj.y;
            const dist = Math.hypot(dx, dy);
            obj.x += (dx / dist) * speed;
            obj.y += (dy / dist) * speed;
            return dist;
        }

        // --- å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã®æ›´æ–°å‡¦ç† ---
        function updateShrimps() {
            for (let i = shrimps.length - 1; i >= 0; i--) {
                const s = shrimps[i];
                const distToCenter = moveTowardsCenter(s, shrimpData.speed);

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡çªåˆ¤å®š
                if (isCollide(player, player.size, s, shrimpData.size) ||
                    (komaruPlayer && isCollide(komaruPlayer, player.size, s, shrimpData.size)) ||
                    (tetsujiPlayer && isCollide(tetsujiPlayer, player.size, s, shrimpData.size))) {
                    shrimps.splice(i, 1);
                    score++;
                    updateScore();
                    continue;
                }
                if (distToCenter < size * 0.12) shrimps.splice(i, 1);
            }
        }

        function updateCucumbers() {
            for (let i = cucumbers.length - 1; i >= 0; i--) {
                const c = cucumbers[i];
                const distToCenter = moveTowardsCenter(c, cucumberData.speed);
                if (isCollide(player, player.size, c, cucumberData.size)) {
                    cucumbers.splice(i, 1);
                    if (!cucumberHasBeenCaught) {
                        cucumberHasBeenCaught = true;
                        activateKomaru();
                    }
                } else if (distToCenter < size * 0.12) {
                    cucumbers.splice(i, 1);
                }
            }
        }

        function updateBaseballs() {
            for (let i = baseballs.length - 1; i >= 0; i--) {
                const b = baseballs[i];
                const distToCenter = moveTowardsCenter(b, baseballData.speed);
                if (isCollide(player, player.size, b, baseballData.size)) {
                    baseballs.splice(i, 1);
                    if (!baseballHasBeenCaught) {
                        baseballHasBeenCaught = true;
                        activateTetsuji();
                    }
                } else if (distToCenter < size * 0.12) {
                    baseballs.splice(i, 1);
                }
            }
        }

        function updateCars() {
            for (let i = cars.length - 1; i >= 0; i--) {
                const car = cars[i];
                const distToCenter = moveTowardsCenter(car, carData.speed);
                if (isCollide(player, player.size, car, carData.size)) {
                    cars.splice(i, 1);
                    score = Math.max(0, score - 5);
                    updateScore();
                } else if (distToCenter < size * 0.12) {
                    cars.splice(i, 1);
                }
            }
        }

        // --- è¡çªåˆ¤å®š ---
        function isCollide(obj1, size1, obj2, size2) {
            return Math.hypot(obj1.x - obj2.x, obj1.y - obj2.y) < (size1 / 2 + size2 / 2);
        }

        // --- ç‰¹æ®Šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
        function activateKomaru() {
            if (!komaruPlayer) {
                komaruPlayer = { ...player, orbitRadius: player.orbitRadius };
                startFeverTime();
            }
        }
        function activateTetsuji() {
            if (!tetsujiPlayer) {
                tetsujiPlayer = { ...player, orbitRadius: player.orbitRadius };
            }
        }

        function updateScore() { scoreEl.textContent = `ã‚¨ãƒ“ãƒ•ãƒ©ã‚¤: ${score}`; }

        // --- æç”» ---
        function drawBlackhole() {
            ctx.save();
            if (isFeverTime) {
                const hue = (performance.now() / 20) % 360;
                const rainbow = ctx.createRadialGradient(center.x, center.y, size * 0.08, center.x, center.y, size * 0.5);
                for (let i = 0; i < 6; i++) rainbow.addColorStop(i / 5, `hsl(${(hue + i * 60) % 360},80%,60%)`);
                ctx.fillStyle = rainbow;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else {
                const disk = ctx.createRadialGradient(center.x, center.y, size * 0.1, center.x, center.y, size * 0.45);
                disk.addColorStop(0, 'rgba(0,0,0,0)');
                disk.addColorStop(0.3, 'orangered');
                disk.addColorStop(0.6, 'orange');
                disk.addColorStop(1, 'rgba(255,215,0,0.3)');
                ctx.fillStyle = disk;
                ctx.beginPath();
                ctx.ellipse(center.x, center.y, size * 0.45, size * 0.25, 0, 0, 2 * Math.PI);
                ctx.fill();
            }
            const rings = [0.13,0.12,0.11,0.10,0.09,0.08];
            rings.forEach((r,i)=>{ctx.strokeStyle = i%2?'black':'orangered';ctx.lineWidth=2;ctx.beginPath();ctx.arc(center.x,center.y,size*r,0,Math.PI*2);ctx.stroke();});
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(center.x, center.y, size * 0.08, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }

        function drawEntity(img, entity, sz) {
            ctx.save();
            ctx.translate(entity.x, entity.y);
            ctx.rotate(entity.angle + Math.PI / 2);
            if (img.complete) ctx.drawImage(img, -sz / 2, -sz / 2, sz, sz);
            ctx.restore();
        }

        function draw() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            drawBlackhole();

            if (gameRunning || score > 0 || timeLeft < GAME_DURATION) {
                shrimps.forEach(s => drawEntity(shrimpImage, s, shrimpData.size));
                cucumbers.forEach(c => drawEntity(cucumberImage, c, cucumberData.size));
                baseballs.forEach(b => drawEntity(baseballImage, b, baseballData.size));
                cars.forEach(car => {
                    ctx.save();
                    ctx.translate(car.x,car.y);
                    ctx.rotate(car.angle + Math.PI/2);
                    if (carImage.complete) ctx.drawImage(carImage, -carData.size/2, -carData.size/4, carData.size, carData.size/2);
                    ctx.restore();
                });
                drawEntity(rosetsuImage, player, player.size);
                if (komaruPlayer)  drawEntity(komaruImage,  komaruPlayer, player.size);
                if (tetsujiPlayer) drawEntity(tetsujiImage, tetsujiPlayer, player.size);
            }
        }

        // --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ---
        function gameLoop(timestamp) {
            if (!gameRunning) return;

            if (timestamp - lastSpawn > shrimpData.spawnRate) {
                lastSpawn = timestamp;
                if (isFeverTime) {
                    spawnShrimp();
                } else if (!cucumberHasBeenCaught && cucumbers.length === 0 && timeLeft < GAME_DURATION - 5 && timeLeft > 10 && Math.random() < 0.3) {
                    spawnCucumber();
                } else if (!baseballHasBeenCaught && baseballs.length === 0 && timeLeft < GAME_DURATION - 5 && timeLeft > 10 && Math.random() < 0.3) {
                    spawnBaseball();
                } else {
                    spawnShrimp();
                }
            }

            const CAR_SPAWN_INTERVAL = 4000;
            if (!isFeverTime && timestamp - lastCarSpawn > CAR_SPAWN_INTERVAL) {
                lastCarSpawn = timestamp;
                spawnCar();
            }

            updatePlayer();
            updateItems();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚° ---
        function setupLeaderboardListener() {
            if (!db) return;
            const q = query(collection(db, "scores"), orderBy("score","desc"), limit(5));
            onSnapshot(q, snap => {
                scoreListEl.innerHTML = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    const idPart = `...${data.userId.slice(-6)}`;
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${data.userId===userId?'YOU':idPart}</span> <span class="score-val">${data.score}</span>`;
                    if (data.userId===userId) li.style.color = '#00bfff';
                    scoreListEl.appendChild(li);
                });
            }, err => {
                console.error(err);
                scoreListEl.innerHTML = '<li>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</li>';
            });
        }

        // --- åˆæœŸæç”» ---
        window.addEventListener('resize', () => {
            size = gameContainer.clientWidth;
            canvas.width = canvas.height = size;
            center = { x: size/2, y: size/2 };
            resetObjects();
            draw();
        });

        let imagesLoaded = 0;
        function onImageLoad(){ if(++imagesLoaded === 7) draw(); }
        rosetsuImage.onload  = onImageLoad;
        shrimpImage.onload   = onImageLoad;
        komaruImage.onload   = onImageLoad;
        cucumberImage.onload = onImageLoad;
        carImage.onload      = onImageLoad;
        baseballImage.onload = onImageLoad; // â˜…
        tetsujiImage.onload  = onImageLoad; // â˜…

        resetObjects();
    </script>
</body>
</html>
