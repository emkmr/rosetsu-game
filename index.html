<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ã‚»ãƒ„ã®ãƒ–ãƒ©ãƒƒã‚¯ãƒ›ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ (å…±æœ‰ç‰ˆ)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700&display=swap');

        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #000000;
            color: #fff;
            font-family: 'Avenir', Hiragino Sans, Arial, sans-serif;
            overflow-x: hidden;
            text-align: center;
            padding: 20px 0;
        }

        #game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #game-container {
            position: relative;
            width: 95vmin;
            height: 95vmin;
            max-width: 600px;
            max-height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: black;
        }

        #game-canvas {
            position: relative;
            z-index: 2;
            background-color: transparent;
            width: 100%;
            height: 100%;
        }

        #ui-container {
            position: absolute;
            top: 2%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3;
            color: white;
            font-size: clamp(1rem, 4vmin, 1.8rem);
            text-shadow: 2px 2px 4px #000;
            display: flex;
            justify-content: space-between;
            width: 90%;
            pointer-events: none;
        }

        #instructions {
            position: absolute;
            bottom: 2%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3;
            color: white;
            font-size: clamp(0.8rem, 2.5vmin, 1rem);
            text-shadow: 2px 2px 4px #000;
            pointer-events: none;
        }

        #start-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            cursor: pointer;
        }
        #start-screen h1 {
            font-size: clamp(1.5rem, 6vmin, 2.2rem);
            margin-bottom: 10px;
            padding: 0 10px;
        }
        #start-screen p {
            font-size: clamp(1rem, 3.5vmin, 1.2rem);
        }
        #final-score {
            font-size: clamp(1.2rem, 4.5vmin, 1.5rem);
            margin: 20px 0;
            color: #ffc107;
        }

        #leaderboard {
            width: 95vmin;
            max-width: 600px;
            padding: 15px;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-top: 20px;
        }
        #leaderboard h2 {
            margin-top: 0;
            color: #0000ff;
            font-size: clamp(1.2rem, 4.5vmin, 1.5rem);
        }
        #leaderboard ol {
            padding-left: 25px;
            margin: 0;
            list-style-type: decimal;
        }
        #leaderboard li {
            font-size: clamp(0.9rem, 3vmin, 1rem);
            padding: 4px 0;
            display: flex;
            justify-content: space-between;
        }
        #leaderboard .score-val {
            font-weight: bold;
            color: #ffffff;
            margin-left: 10px;
        }
        #user-id-display {
            position: fixed;
            bottom: 5px;
            left: 5px;
            font-size: 0.7em;
            color: rgba(255,255,255,0.3);
            z-index: 20;
        }

    </style>
</head>
<body>

    <div id="game-wrapper">
        <div id="game-container">
            <canvas id="game-canvas"></canvas>
            <div id="ui-container">
                <span id="score">ã‚¨ãƒ“ãƒ•ãƒ©ã‚¤: 0</span>
                <span id="timer"></span>
            </div>
            <div id="instructions">
                Use â—€ï¸ / â–¶ï¸ keys or tap the screen!
            </div>

            <div id="start-screen">
                <h1> catch me if you can<br>ãƒ­ã‚»ãƒ„ã¨ã‚¨ãƒ“ãƒ•ãƒ©ã‚¤</h1>
                <p id="start-text">Click or Tap to Start â–¶ï¸ </p>
                <div id="final-score"></div>
            </div>
        </div>
        <div id="leaderboard">
            <h2>ğŸš€ğŸ¤ HIGH SCORE RANKING ğŸ¤ğŸš€</h2>
            <ol id="score-list"></ol>
        </div>
    </div>
    <div id="user-id-display"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyBDl5BYLTUbMQtuLqvXdlxpw1Ir0wX6NQg",
            authDomain: "rosetsu-game.firebaseapp.com",
            projectId: "rosetsu-game",
            storageBucket: "rosetsu-game.firebasestorage.app",
            messagingSenderId: "679751851017",
            appId: "1:679751851017:web:57ea539491b2ac91162cd8"
        };

        // --- DOMè¦ç´ ã®å–å¾— ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const timerEl = document.getElementById('timer');
        const startScreen = document.getElementById('start-screen');
        const startText = document.getElementById('start-text');
        const finalScoreEl = document.getElementById('final-score');
        const gameContainer = document.getElementById('game-container');
        const scoreListEl = document.getElementById('score-list');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- ã‚²ãƒ¼ãƒ è¨­å®š ---
        let score = 0;
        let gameRunning = false;
        const GAME_DURATION = 30;
        let timerId;
        let timeLeft = GAME_DURATION;

        // --- ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºè¨­å®š ---
        let size = gameContainer.clientWidth;
        canvas.width = size;
        canvas.height = size;
        let center = { x: size / 2, y: size / 2 };

        // --- Firebase åˆæœŸåŒ– ---
        let db, auth, userId;
        try {
            if (firebaseConfig.apiKey === "YOUR_API_KEY" || !firebaseConfig.apiKey) {
                throw new Error("Firebase config is not set. Please follow the setup guide.");
            }
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId.slice(0,8)}...`;
                    setupLeaderboardListener();
                }
            });
            signInAnonymously(auth);

        } catch (error) {
            console.error(error.message);
            scoreListEl.innerHTML = '<li>Firebaseã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚ã‚¬ã‚¤ãƒ‰ã«å¾“ã£ã¦è¨­å®šæƒ…å ±ã‚’ã‚³ãƒ¼ãƒ‰ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</li>';
            userIdDisplay.textContent = "DBè¨­å®šã‚¨ãƒ©ãƒ¼";
            startText.innerHTML = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã‚’ä½¿ã†ã«ã¯<br>è¨­å®šãŒå¿…è¦ã§ã™";
        }

        // --- SVGãƒ‡ãƒ¼ã‚¿ ---
        const rosetsuSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="30 28 40 50"><g><ellipse cx="50" cy="60" rx="11" ry="15" fill="white" stroke="black" stroke-width="2" /><ellipse cx="50" cy="40" rx="12.5" ry="10" fill="white" stroke="black" stroke-width="2" /><path d="M 42.5 38 Q 35 33, 35 40" fill="white" stroke="black" stroke-width="2" /><path d="M 57.5 38 Q 65 33, 65 40" fill="white" stroke="black" stroke-width="2" /><circle cx="46" cy="39" r="1" fill="black" /><circle cx="54" cy="39" r="1" fill="black" /><circle cx="50" cy="42" r="1" fill="black" /><path d="M 46 45 Q 50 46, 54 45" stroke="black" stroke-width="1" fill="none" /></g><g><rect x="39" y="50" width="21" height="16" fill="#ffffe0" stroke="black" stroke-width="1.5" /><rect x="32" y="50" width="6" height="10" fill="#ffffe0" stroke="black" stroke-width="1.5" /><rect x="61" y="50" width="6" height="10" fill="#ffffe0" stroke="black" stroke-width="1.5" /></g></svg>`;
        const rosetsuImage = new Image();
        rosetsuImage.src = `data:image/svg+xml;base64,${btoa(rosetsuSVG)}`;

        const shrimpSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="45 50 10 15"><g><path d="M 49.5 54 Q 52.5 51, 49.5 52" fill="red" stroke="black" stroke-width="0.4" /> <path d="M 49.5 54 Q 46.5 51, 49.5 52" fill="red" stroke="black" stroke-width="0.4" /> <ellipse cx="49.5" cy="57.5" rx="2" ry="5" fill="#FF9800" stroke="black" stroke-width="0.4" /><ellipse cx="49.5" cy="57.5" rx="2.4" ry="5.6" fill="none" stroke="black" stroke-dasharray="0.8" stroke-width="0.2" /></g></svg>`;
        const shrimpImage = new Image();
        shrimpImage.src = `data:image/svg+xml;base64,${btoa(shrimpSVG)}`;

        // --- ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š ---
        let player = {};
        let shrimps = [];
        let shrimpData = {};
        const keys = { left: false, right: false };
        let lastSpawn = -1;

        function resetObjects() { player = { size: size * 0.08, angle: 0, speed: 0.05, orbitRadius: size * 0.3, x: 0, y: 0 }; shrimps = []; shrimpData = { size: size * 0.06, spawnRate: 1000, speed: 1 }; }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        window.addEventListener('keydown', (e) => { if(gameRunning) { if (e.key === 'ArrowLeft') keys.left = true; if (e.key === 'ArrowRight') keys.right = true; }});
        window.addEventListener('keyup', (e) => { if (e.key === 'ArrowLeft') keys.left = false; if (e.key === 'ArrowRight') keys.right = false; });
        canvas.addEventListener('touchstart', (e) => { if(gameRunning) { e.preventDefault(); const touchX = e.touches[0].clientX - canvas.getBoundingClientRect().left; keys.left = touchX < canvas.width / 2; keys.right = touchX >= canvas.width / 2; }});
        canvas.addEventListener('touchend', (e) => { e.preventDefault(); keys.left = false; keys.right = false; });
        startScreen.addEventListener('click', () => { if (!gameRunning && firebaseConfig.apiKey !== "YOUR_API_KEY") startGame() });

        // --- ã‚²ãƒ¼ãƒ é€²è¡Œ ---
        function startGame() { gameRunning = true; score = 0; timeLeft = GAME_DURATION; finalScoreEl.textContent = ''; startText.textContent = ''; startScreen.style.display = 'none'; resetObjects(); updateScore(); timerEl.textContent = `æ®‹ã‚Šæ™‚é–“: ${timeLeft}`; timerId = setInterval(() => { timeLeft--; timerEl.textContent = `æ®‹ã‚Šæ™‚é–“: ${timeLeft}`; if (timeLeft <= 0) { endGame(); }}, 1000); gameLoop(); }
        async function endGame() { clearInterval(timerId); gameRunning = false; keys.left = false; keys.right = false; finalScoreEl.textContent = `Final Score: ${score}`; startText.textContent = "Play Againï¼"; startScreen.style.display = 'flex'; if (db && userId) { try { await addDoc(collection(db, "scores"), { userId: userId, score: score, timestamp: serverTimestamp() }); } catch (error) { console.error("Error writing document: ", error); }}}

        // --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---
        function spawnShrimp() { const angle = Math.random() * Math.PI * 2; const radius = size * 0.48; shrimps.push({ x: center.x + radius * Math.cos(angle), y: center.y + radius * Math.sin(angle), angle: angle, });}
        function updatePlayer() { if (keys.left) player.angle -= player.speed; if (keys.right) player.angle += player.speed; player.x = center.x + player.orbitRadius * Math.cos(player.angle); player.y = center.y + player.orbitRadius * Math.sin(player.angle);}
        function updateShrimps() { for (let i = shrimps.length - 1; i >= 0; i--) { const s = shrimps[i]; const dx = center.x - s.x; const dy = center.y - s.y; const dist = Math.sqrt(dx * dx + dy * dy); s.x += (dx / dist) * shrimpData.speed; s.y += (dy / dist) * shrimpData.speed; const playerDist = Math.sqrt(Math.pow(player.x - s.x, 2) + Math.pow(player.y - s.y, 2)); if (playerDist < player.size / 2 + shrimpData.size / 2) { shrimps.splice(i, 1); score++; updateScore(); } else if (dist < size * 0.12) { shrimps.splice(i, 1); }}}
        function updateScore() { scoreEl.textContent = `ã‚¨ãƒ“ãƒ•ãƒ©ã‚¤: ${score}`; }

        // --- æç”» ---
        function drawBlackhole() { ctx.save(); const diskGradient = ctx.createRadialGradient(center.x, center.y, size * 0.1, center.x, center.y, size * 0.45); diskGradient.addColorStop(0, 'rgba(0,0,0,0)'); diskGradient.addColorStop(0.3, 'orangered'); diskGradient.addColorStop(0.6, 'orange'); diskGradient.addColorStop(1, 'rgba(255, 215, 0, 0.3)'); ctx.fillStyle = diskGradient; ctx.beginPath(); ctx.ellipse(center.x, center.y, size * 0.45, size * 0.25, 0, 0, 2 * Math.PI); ctx.fill(); ctx.fillStyle = "rgba(255, 165, 0, 0.7)"; ctx.beginPath(); ctx.moveTo(center.x, center.y); ctx.lineTo(size * 0.1, center.y - size * 0.02); ctx.lineTo(size * 0.1, center.y + size * 0.02); ctx.closePath(); ctx.fill(); ctx.beginPath(); ctx.moveTo(center.x, center.y); ctx.lineTo(size * 0.9, center.y - size * 0.02); ctx.lineTo(size * 0.9, center.y + size * 0.02); ctx.closePath(); ctx.fill(); const rings = [{ r: 0.13, c: "orangered" }, { r: 0.12, c: "black" }, { r: 0.11, c: "orangered" }, { r: 0.10, c: "black" }, { r: 0.09, c: "orangered" }, { r: 0.08, c: "black" }]; rings.forEach(ring => { ctx.strokeStyle = ring.c; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(center.x, center.y, size * ring.r, 0, 2 * Math.PI); ctx.stroke(); }); ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(center.x, center.y, size * 0.08, 0, 2 * Math.PI); ctx.fill(); ctx.restore(); }
        function drawGameObjects() { ctx.save(); ctx.translate(player.x, player.y); ctx.rotate(player.angle + Math.PI / 2); if (rosetsuImage.complete) { ctx.drawImage(rosetsuImage, -player.size / 2, -player.size / 2, player.size, player.size); } ctx.restore(); shrimps.forEach(s => { ctx.save(); ctx.translate(s.x, s.y); ctx.rotate(s.angle + Math.PI / 2); if (shrimpImage.complete) { ctx.drawImage(shrimpImage, -shrimpData.size / 2, -shrimpData.size / 2, shrimpData.size, shrimpData.size); } ctx.restore(); });}
        function draw() { ctx.clearRect(0, 0, canvas.width, canvas.height); drawBlackhole(); if (gameRunning || score > 0 || timeLeft < GAME_DURATION) { drawGameObjects(); }}

        // --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ---
        function gameLoop(timestamp) { if (!gameRunning) return; if (timestamp - lastSpawn > shrimpData.spawnRate) { lastSpawn = timestamp; spawnShrimp(); } updatePlayer(); updateShrimps(); draw(); requestAnimationFrame(gameLoop); }

        // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚° ---
        function setupLeaderboardListener() {
            if (!db) return;
            const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(5));
            onSnapshot(q, (snapshot) => {
                scoreListEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const idPart = `...${data.userId.slice(-6)}`;
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${data.userId === userId ? 'YOU' : idPart}</span> <span class="score-val">${data.score}</span>`;
                    if (data.userId === userId) {
                        li.style.color = '#ffeb3b';
                    }
                    scoreListEl.appendChild(li);
                });
            }, (error) => { console.error("Error getting leaderboard: ", error); scoreListEl.innerHTML = '<li>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</li>'; });
        }

        // --- åˆæœŸåŒ– ---
        window.addEventListener('resize', () => { size = gameContainer.clientWidth; canvas.width = size; canvas.height = size; center = { x: size / 2, y: size / 2 }; resetObjects(); draw(); });
        let imagesLoaded = 0;
        function onImageLoad() { if (++imagesLoaded === 2) { draw(); }}
        rosetsuImage.onload = onImageLoad;
        shrimpImage.onload = onImageLoad;
        resetObjects();
    </script>
</body>
</html>

